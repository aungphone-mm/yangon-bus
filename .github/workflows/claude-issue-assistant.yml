name: Claude Issue Assistant

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

permissions:
  issues: write
  contents: read

jobs:
  respond:
    runs-on: ubuntu-latest

    # Only run if @claude is mentioned
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Prepare issue context
        id: context
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_BODY="${{ github.event.issue.body }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            AUTHOR="${{ github.event.issue.user.login }}"
          else
            ISSUE_BODY="${{ github.event.comment.body }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            AUTHOR="${{ github.event.comment.user.login }}"
          fi

          # Remove @claude mention to clean up the prompt
          CLEAN_BODY=$(echo "$ISSUE_BODY" | sed 's/@claude//g')

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

          # Save body to file to handle multiline
          echo "$CLEAN_BODY" > /tmp/issue_body.txt

      - name: Call Claude API
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_BODY=$(cat /tmp/issue_body.txt)
          ISSUE_TITLE="${{ steps.context.outputs.issue_title }}"

          # Create the API request with proper JSON escaping using jq
          jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY" \
            '{
              "model": "claude-sonnet-4-5-20250929",
              "max_tokens": 4096,
              "messages": [
                {
                  "role": "user",
                  "content": ("You are a helpful assistant for the Yangon Bus Transit App project. A user has asked for help in a GitHub issue.\n\nIssue Title: " + $title + "\n\nUser Question:\n" + $body + "\n\nPlease provide a helpful, concise response. If the question is about the codebase, refer to the project structure (Next.js 14, TypeScript, bus route planning app for Yangon, Myanmar with 2,093 stops and 125 routes). Focus on being specific and actionable.")
                }
              ]
            }' > /tmp/request.json

          # Call the API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @/tmp/request.json)

          # Extract the response text
          CLAUDE_RESPONSE=$(echo "$RESPONSE" | jq -r '.content[0].text // "I encountered an error processing your request. Please try again."')

          # Save to file for multiline handling
          echo "$CLAUDE_RESPONSE" > /tmp/claude_response.txt

      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const response = fs.readFileSync('/tmp/claude_response.txt', 'utf8');
            const author = '${{ steps.context.outputs.author }}';

            const body = `ðŸ‘‹ Hi @${author}! I'm Claude, an AI assistant for this project.

${response}

---
*This response was generated by Claude (Sonnet 4.5). If you need further assistance, feel free to mention @claude again.*`;

            await github.rest.issues.createComment({
              issue_number: ${{ steps.context.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
